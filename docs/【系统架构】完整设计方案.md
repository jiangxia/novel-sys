# 小说创作系统 - 系统架构完整设计方案

## 第一部分：产品定义 (15%)

### 项目目标和定位

基于用户使用流程的Epic划分，确保每个Epic都有明确的界面产出和功能边界。本系统采用前后端分离架构，以AI驱动的4角色协作为核心，实现本地化优先的小说创作工作流。

### 整体技术架构概述

```
Frontend(React) ──→ Backend(Node.js) ──→ External APIs(Gemini/PromptX)
       │
Local FileSystem
```

**完整技术栈**：
- **前端技术**：React 18 + TypeScript + Vite + Zustand(状态管理) + Shadcn/ui(组件库) + Monaco Editor(编辑器)
- **后端技术**：Node.js + Express + TypeScript + 原生Gemini API + MCP集成
- **设计原则**：前后端分离 + Apple Style设计 + 响应式布局 + 本地化优先 + 模块化设计 + 高健壮性
- **核心架构**：AI驱动4角色协作 + 本地文件系统 + File System Access API

### Epic拆解规划

#### Epic 0: 技术环境搭建

**目标**：搭建前后端基础架构，确保项目正常运行
**权限**：允许修改配置文件(package.json/tsconfig等)，新增基础组件，禁止修改文档和已有源文件

### 核心功能
**前端环境**：
- React 18 + TypeScript + Vite项目初始化
- 基础组件库集成（Shadcn/ui）
- 状态管理配置（Zustand）
- 基础路由配置和页面结构
- TypeScript配置和编译验证

**后端环境**：
- Node.js + Express + TypeScript项目初始化
- 基础API路由框架搭建
- CORS跨域配置
- 错误处理中间件
- TypeScript配置和编译验证

**项目结构**：
- 统一的前后端monorepo项目结构
- package.json配置和依赖管理
- 开发脚本配置（dev/build/test）
- 基础环境变量配置

**验证功能**：
- 前端Hello World页面
- 后端健康检查API接口
- 前后端基础通信验证

**验收标准**：
- 功能要求：前端(3000)后端(3001)正常启动，构建无错误，API通信正常
- 体验要求：用户看到页面正常加载，无错误提示，技术细节对用户透明

#### Epic 1: 项目导入引导流程

**目标**：实现用户打开网站后的项目导入引导，整个应用的入口
**权限**：允许修改App.tsx，新增导入相关页面/组件/Hook，禁止修改后端和API类型

### 核心功能
- 欢迎页面和导入引导（包含目录规范示例文字）
- 目录选择和严格目录名称验证（精确匹配4个标准目录）
- 空目录自动创建标准4目录结构：`0-小说设定`、`1-故事大纲`、`2-故事概要`、`3-小说内容`
- 缺失目录识别和用户手动创建提示（使用精确目录名称）
- 严格格式示例展示和重新导入机制
- 导入成功后的界面状态切换

**验收标准**：
- 功能要求：支持标准目录结构导入，空目录自动创建，缺失目录提示手动创建，最终切换到主工作界面
- 体验要求：一键导入按钮+规范说明，严格验证+明确反馈，用户感受"规范清晰，操作简单"

#### Epic 2: 主工作界面搭建

**目标**：构建导入成功后显示的完整工作界面框架，所有界面组件一次性完整实现
**权限**：允许新增工作区组件/编辑器组件/状态管理，禁止修改后端代码和API接口类型

### 核心功能
**左侧交互区(响应式)**：
- **简洁切换系统**：[对话] | [项目] 选项卡
- **对话Tab内容**：AI角色对话区 + 消息滚动 + 输入框
- **项目Tab内容**：文件列表 + 直观的目录结构

**右侧内容区(自适应)**：
- **单文件编辑**：当前打开的文件编辑器
- **文档编辑区**：Markdown富文本编辑 + 自动保存

**完整界面布局**：
```
┌─────────────────┬───────────────────────────────┐
│   左侧交互区    │        右侧内容区              │
├─────────────────┼───────────────────────────────┤
│  [对话] [项目]  │      当前编辑文件Tab           │
│                 │    ┌─────────────────────────┐  │
│ ┌─────────────┐ │    │ 文件名.md            × │  │
│ │AI角色对话区 │ │    └─────────────────────────┘  │
│ │+ 角色切换   │ │                               │
│ └─────────────┘ │         文档编辑区域            │
│      或         │                               │
│ ┌─────────────┐ │                               │
│ │项目导航树   │ │                               │
│ └─────────────┘ │                               │
└─────────────────┴───────────────────────────────┘
```

**验收标准**：
- 功能要求：完整工作界面，对话/项目Tab切换，文件浏览，右侧单文件编辑器，所有交互可用
- 体验要求：专业创作工作台感受，左侧直观切换，右侧清晰编辑环境，界面简洁舒适，响应流畅无卡顿

#### Epic 3: 文件操作功能

**目标**：实现基础的文件读取、编辑、保存功能
**权限**：允许新增文件系统服务/API/中间件，禁止修改后端入口和其他Epic文件

### 核心功能
- 文件读取显示
- 编辑和保存
- 实时同步本地

**验收标准**：
- 功能要求：文件打开/编辑/保存，所有修改实时同步本地
- 体验要求：点击即可编辑，输入流畅，保存透明（自动+手动），状态明确，确信数据安全

#### Epic 4: AI基础服务集成

### 目标
建立基础的Google Gemini API连接和对话功能

### 核心功能
**原生Gemini API集成**：
- 原生Google Gemini API客户端实现
- 基础对话接口和错误处理
- API重试机制和性能优化
- 对话上下文管理

**技术架构**：
```javascript
backend/
├── lib/
│   ├── gemini-client.js     // 原生Gemini客户端
│   ├── conversation-manager.js // 对话上下文管理
│   └── error-handler.js     // 错误处理和重试
├── routes/
│   └── chat.js              // 对话API路由
├── config/
│   └── gemini-config.json   // Gemini API配置
```

**验收标准**：
- 功能要求：通过Gemini API对话，稳定API调用，基础上下文管理
- 体验要求：左侧对话区输入，稳定回复，响应<10秒，加载提示明确，感受"智能助手帮助"而非复杂工具

#### Epic 5: PromptX MCP集成

### 目标
基于MCP协议集成PromptX服务，建立角色和记忆系统基础

### 核心功能
**MCP客户端集成**：
- 集成`@modelcontextprotocol/sdk`客户端
- 配置PromptX MCP服务器连接
- 实现MCP工具调用封装(promptx_action, promptx_remember, promptx_recall)

**记忆系统集成**：
- PromptX记忆保存和回忆功能
- 智能记忆触发机制
- 会话记忆与长期记忆结合

**技术架构**：
```javascript
backend/
├── lib/
│   ├── mcp-client.js        // 核心MCP客户端
│   ├── promptx-client.js    // PromptX专用封装
│   └── memory-manager.js    // 记忆管理器
├── config/
│   └── mcp-servers.json     // MCP服务器配置
```

**验收标准**：
- 功能要求：成功连接PromptX MCP服务，实现记忆保存和回忆功能，为角色系统提供基础支持
- 体验要求：用户无感知MCP复杂性，发现AI助手"变聪明"，记住创作内容和偏好，后台智能管理记忆

#### Epic 6: 总监角色验证集成

### 目标
集成并验证总监角色的完整功能

### 核心功能
**总监角色激活**：
- 通过MCP调用总监角色
- 角色状态管理和上下文维护
- 总监专业能力验证

**功能验证**：
- 总监的全局统筹功能
- 质量把控和建议能力
- 跨文章协调功能测试

**验收标准**：
- 功能要求：总监角色正常激活和工作，提供专业全局建议和质量把控功能
- 体验要求：点击"总监"后对话风格明显变化，宏观视角统筹建议，像经验丰富编辑审视作品，提供专业全局指导

#### Epic 7: 完整４角色系统集成

### 目标
集成剩余的架构师、规划师、写手角色，建立完整的4角色协作系统

### 核心功能
**剩余3角色集成**：
- 架构师角色激活和验证
- 规划师角色激活和验证  
- 写手角色激活和验证

**角色协作机制**：
- 智能角色路由系统
- 角色间状态传递
- 统一的角色管理接口

**系统集成测试**：
- 4角色完整对话流程测试
- 角色切换和状态管理验证
- 系统稳定性和性能测试

**验收标准**：
- 功能要求：与完整4角色系统协作，根据内容类型智能路由角色，角色切换流畅稳定
- 体验要求：拥有完整"创作团队"，每个角色专业特色鲜明(架构师-世界观/规划师-情节/写手-文字/总监-质量)，不同阶段合适专业协助，切换自然流畅

#### Epic 8: 架构师角色创作流程

### 目标
实现架构师角色主导的小说设定创作完整流程

### 技术实现说明
**设计创新**：
- **三维度MECE架构**：World(What) + Theme(Why) + Character(Who) 完整覆盖设定要素
- **5步引导流程**：通过提示词工程实现AI行为模式，无需代码逻辑
- **智能归类**：利用AI天然语言理解能力

**实际开发需求**：
- 3个预定义Markdown模板文件
- 架构师角色系统提示词（包含5步工作方法）
- 文件读写功能

**开发复杂度**：极低 - 主要是提示词设计工作

### 核心功能
- 架构师角色提示词设计（包含5步引导流程）
- 三维度模板文件创建（故事世界/主题/角色）
- 文件生成和保存功能

**验收标准**：
- 功能要求：与架构师完成完整世界观设定，输出符合标准模板的3个设定文件
- 体验要求：像与资深编剧聊天般自然表达创意，架构师耐心听取并智能整理归类，无需记忆复杂模板格式，专注创意表达，获得专业完整世界观文档，感受"想法更有条理"

#### Epic 9: 规划师角色创作流程（大纲）

### 目标
实现规划师角色主导的故事大纲创作流程

### 技术实现说明
**设计理念**：
- **4步创作流程**：规划师AI角色的工作方法，通过提示词工程实现
- **四要素大纲模板**：结构化的信息架构设计，AI天然理解
- **对话式调整**：用户与AI自然对话来优化大纲内容

**实际开发需求**：
- 1个四要素大纲Markdown模板文件
- 规划师角色系统提示词（包含4步工作方法）
- 文件读写功能

**开发复杂度**：极低 - 主要是提示词设计工作

### 核心功能
- 规划师角色提示词设计（包含4步创作流程）
- 四要素大纲模板文件创建（背景设定/主题立意/核心事件/价值意义）
- 大纲文件生成和保存功能

**验收标准**：
- 功能要求：与规划师创建完整故事大纲，确保与设定内容一致
- 体验要求：讨论故事走向时像与专业策划师合作，规划师深度理解设定内容，提供符合世界观情节建议，用户专注创意，规划师负责结构化整理，得到逻辑清晰主题明确大纲

#### Epic 10: 规划师角色创作流程（概要）

### 目标
实现基于6步逻辑骨架的详细故事概要创作

### 技术实现说明
**设计理念**：
- **6步逻辑骨架**：规划师AI角色的结构化思维模式，通过提示词工程实现
- **详细概要模板**：结构化的信息架构设计，AI天然理解
- **质量检查机制**：AI的自我检查能力，通过提示词指导实现

**用户交互流程**：
1. 用户指定要创作哪一章的故事概要
2. 系统发送请求给AI（包含规划师角色提示词 + 6步逻辑要求）
3. AI按提示词执行，生成符合6步逻辑骨架的概要
4. 用户通过对话与AI互动修改完善概要内容

**实际开发需求**：
- 1个详细的故事概要Markdown模板文件
- 规划师角色系统提示词（包含6步逻辑骨架 + 质量检查标准）
- 文件读写功能

**开发复杂度**：极低 - 主要是提示词设计工作

### 核心功能
- 规划师角色提示词设计（包含6步逻辑骨架思维模式）
- 详细故事概要模板文件创建（基本信息/情节发展/关键要素/衔接控制）
- 概要文件生成和保存功能

**验收标准**：
- 功能要求：创建详细故事概要，严格遵循6步逻辑结构，与大纲保持一致
- 体验要求：规划师引导下将大纲细化为具体故事框架，像资深编剧帮助完善剧本结构，确保每个情节点逻辑支撑，获得直接指导写作的详细蓝图，心中有底"知道怎么写"

#### Epic 11: 写手角色创作流程

### 目标
实现写手角色主导的高质量小说内容创作

### 技术实现说明
**设计理念**：
- **结构化创作流程**：写手AI角色的创作方法，通过提示词工程实现
- **品质自检机制**：AI的自我检查能力，通过提示词指导实现
- **修订工作规范**：AI的修改标准，内置在角色提示词中

**用户交互流程**：
1. 用户指定要创作哪一章的小说内容
2. 系统发送请求给AI（包含写手角色提示词 + 概要依赖内容）
3. AI按提示词执行，基于概要的6步逻辑结构创作完整小说内容
4. 系统将AI生成的小说内容直接写入对应文件
5. 用户审查确认，通过对话与AI互动修改完善

**实际开发需求**：
- 写手角色系统提示词（包含创作流程 + 品质自检 + 修订规范）
- 文件读写功能

**开发复杂度**：极低 - 主要是提示词设计工作

### 核心功能
- 写手角色提示词设计（包含结构化创作流程和品质标准）
- 小说内容文件生成和保存功能

**验收标准**：
- 功能要求：与写手创作高质量小说内容，严格按照概要结构执行
- 体验要求：协作时像与专业作家共同创作，写手提供文字润色建议并主动创作符合概要要求内容片段，用户专注创意和情感表达，写手负责文学技巧和语言品质，产出满意的高质量小说章节


### 开发优先级规划

### 阶段0：技术搭建（Epic 0）
搭建前后端基础技术架构，确保项目能正常运行和构建

### 阶段1：基础架构（Epic 1-3）
建立完整的项目导入、主工作界面和文件操作基础，用户可以基本使用系统

### 阶段2：AI基础服务（Epic 4-5）
建立大模型API连接和PromptX MCP集成基础，为AI功能提供支撑

### 阶段3：角色系统建立（Epic 6-7）
先验证总监角色，再完成完整4角色系统集成，确保角色系统稳定可用

### 阶段4：创作流程核心（Epic 8-11）
按创作阶段顺序实现4角色的完整创作流程：设定→大纲→概要→内容


## 总结

此Epic架构设计遵循了前端开发的基本规律：先静态页面、后动态交互、再业务逻辑。确保每个阶段都有明确的产出和可验证的功能点。

---

## 第二部分：实施方案 (70%)

### 开发路径和优先级

### 技术选型和API设计


#### 项目目录结构

### 项目目录结构
```
novel-sys/
├── src/
│   ├── client/          # 前端：React组件/页面/状态管理/Hook/服务
│   ├── server/          # 后端：API路由/业务服务/AI服务/中间件/models
│   ├── shared/          # 共享：类型/常量/工具/数据验证
│   └── config/          # 配置管理
├── docs/                # 项目文档和设计方案
└── public/scripts/      # 静态资源和构建脚本
```

#### 前端模块设计

**UI框架选择：Shadcn/ui + Apple Style设计**
- **Apple Style适配**：支持清晰、内容优先的设计原则
- **响应式支持**：基于Tailwind CSS，天然支持响应式布局
- **高度定制化**：组件代码直接复制到项目，可自由修改样式和逻辑
- **性能优异**：无运行时依赖，只包含使用的组件代码
- **TypeScript友好**：原生TypeScript支持，完整类型安全

**核心组件**：
- 工作区布局：左侧交互区(响应式) + 右侧内容区(自适应)
- 左侧：对话Tab + 项目Tab，右侧：简洁单文件编辑器
- 关键组件：Resizable(响应式分栏) + Dialog(弹窗) + Toast(提示) + 简洁Tab

**状态管理**：Zustand管理app/project/ai/files状态
**服务层**：API服务 + 文件服务 + File System Access API

#### 后端模块设计

#### 核心服务

**Express应用**：
- 安全中间件：helmet + cors + morgan
- API路由：/api/ai + /api/file + /api/project
- 健康检查 + 全局错误处理

**AI服务设计：直接Gemini API**

**技术选型**：
- **模型**：仅支持Google Gemini API
- **实现方式**：原生API调用，简单直接
- **角色系统**：基于prompt模板切换角色
- **记忆管理**：依托PromptX自带记忆功能

**AI服务管理**：
- **Gemini API**：直接调用，基础错误处理
- **4角色系统**：通过prompt模板实现角色切换
- **记忆管理**：完全依托PromptX自带记忆功能

### 通信协议和接口设计

#### HTTP API设计

**响应格式**：{success, data?, error?, timestamp}
**核心接口**：
- AI类：/api/ai/roles/activate + /api/ai/chat + /api/ai/memory
- 项目类：/api/project/import + /api/project/validate
- 文件类：/api/file/read + /api/file/write + /api/file/list

**Gemini API核心实现**：
```typescript
// 保留接口抽象，便于后续扩展
interface BaseAIProvider {
  chat(message: string, role?: string): Promise<string>;
}

// Gemini实现
class GeminiAIService implements BaseAIProvider {
  private geminiClient: GeminiClient;
  private baseURL = 'https://generativelanguage.googleapis.com/v1beta';
  
  async chat(message: string, role?: string): Promise<string> {
    const response = await fetch(`${this.baseURL}/models/gemini-pro:generateContent?key=${this.apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: this.formatMessages([{role: 'user', content: role ? `${role}\n\n${message}` : message}]),
        generationConfig: { temperature: 0.7, maxOutputTokens: 2048 }
      })
    });
    
    if (!response.ok) throw new Error(`Gemini API error: ${response.statusText}`);
    return response.json();
  }

  private formatMessages(messages: any[]) {
    return messages.map(msg => ({
      role: msg.role === 'assistant' ? 'model' : 'user',
      parts: [{ text: msg.content }]
    }));
  }
}
```

#### API通信机制

**简化设计**：使用标准HTTP API，无需WebSocket复杂性

## 第三部分：质量保证 (15%)

### 健壮性和错误处理

#### 错误处理机制

**简化错误处理**：
```typescript
// 基础try-catch错误处理
try {
  const result = await aiService.chat(message);
  res.json({ success: true, data: result });
} catch (error) {
  res.status(500).json({ 
    success: false, 
    error: error.message || 'AI服务暂时不可用' 
  });
}
```

### 部署和监控方案

#### 本地开发部署
**开发服务**：
- frontend：React应用(3000端口)
- backend：Node.js API(3001端口)

#### 监控和日志
**健康检查**：基本服务状态检查
```typescript
// 简单的健康检查接口
app.get('/health', (req, res) => {
  res.json({ 
    status: 'ok', 
    timestamp: new Date().toISOString(),
    service: 'novel-creation-system' 
  });
});
```
**日志系统**：console.log基础日志

### 开发配置和环境

#### 配置管理

**简化配置**：直接读取环境变量
```typescript
// 配置直接从环境变量读取
const config = {
  geminiApiKey: process.env.GEMINI_API_KEY!,
  frontendUrl: process.env.FRONTEND_URL || 'http://localhost:3000',
  appName: '小说创作系统'
};
```

**环境变量**：GEMINI_API_KEY（必需）+ FRONTEND_URL（可选）


### 架构优势和风险控制

#### 架构优势
- **极简设计**：直接Gemini API调用，无中间层
- **快速开发**：去掉复杂抽象，专注核心功能
- **易于调试**：问题直接定位，无复杂依赖链
- **稳定可靠**：减少故障点，提高系统稳定性

#### 风险缓解措施
- **AI服务不稳定** → 基础错误提示
- **本地文件限制** → File System Access API
- **记忆管理** → 完全依托PromptX处理

该架构遵循奥卡姆剃刀原则：最简方案解决核心需求，避免过度工程化。