# 小说创作系统 - Epic架构设计

## 总体架构概述

基于用户使用流程的Epic划分，确保每个Epic都有明确的界面产出和功能边界。

## Epic 0: 技术环境搭建

### 目标
搭建基础的前后端技术架构，确保项目能正常运行、构建和部署

### 文件权限控制
**允许修改**：
- `package.json`
- `vite.config.ts`
- `tsconfig.json`
- `src/server/tsconfig.json`

**允许新增**：
- `src/client/src/components/`(新建基础组件)
- `src/shared/types/`(新建类型定义)

**禁止修改**：
- `.github/`
- `docs/`
- 已有源文件(除非明确需要修复)

### 核心功能
**前端环境**：
- React 18 + TypeScript + Vite项目初始化
- 基础组件库集成（Shadcn/ui）
- 状态管理配置（Zustand）
- 基础路由配置和页面结构
- TypeScript配置和编译验证

**后端环境**：
- Node.js + Express + TypeScript项目初始化
- 基础API路由框架搭建
- CORS跨域配置
- 错误处理中间件
- TypeScript配置和编译验证

**项目结构**：
- 统一的前后端monorepo项目结构
- package.json配置和依赖管理
- 开发脚本配置（dev/build/test）
- 基础环境变量配置

**验证功能**：
- 前端Hello World页面
- 后端健康检查API接口
- 前后端基础通信验证

### 成功标准
- `npm run dev` 能成功启动前端开发服务器（3000端口）
- `npm run server` 能成功启动后端API服务器（3001端口）
- `npm run build` 能成功构建前后端代码
- 前端能成功请求后端API并获得响应
- TypeScript编译无错误，项目结构清晰

### 成功标准——用户交互
用户访问网站后能看到基础页面正常加载，无明显错误提示，为后续Epic提供稳定的技术基础，用户不需要关心技术细节，只需要系统能正常运行。

### 开发总结要求
- [ ] **技术架构搭建总结已完成**
- [ ] 记录关键技术选型原因
- [ ] 记录遇到的主要问题和解决方案
- [ ] 记录性能基准数据

## Epic 1: 项目导入引导流程

### 目标
实现用户打开网站后的项目导入引导，这是整个应用的入口

### 文件权限控制
**允许修改**：
- `src/client/src/App.tsx`

**允许新增**：
- `src/client/src/pages/import/`(导入相关页面)
- `src/client/src/components/import/`(导入组件)
- `src/client/src/hooks/useFileSystem.ts`(文件系统Hook)

**禁止修改**：
- `src/server/app.ts`(后端入口)
- `src/shared/types/api.ts`(已有API类型)

### 核心功能
- 欢迎页面和导入引导（包含目录规范示例文字）
- 目录选择和严格目录名称验证（精确匹配4个标准目录）
- 空目录自动创建标准4目录结构：`0-小说设定`、`1-故事大纲`、`2-故事概要`、`3-小说内容`
- 缺失目录识别和用户手动创建提示（使用精确目录名称）
- 严格格式示例展示和重新导入机制
- 导入成功后的界面状态切换

### 成功标准
用户通过界面引导了解标准目录规范（`0-小说设定`、`1-故事大纲`、`2-故事概要`、`3-小说内容`），可以成功导入完整的本地项目，或在空目录中自动获得标准结构，缺失目录时能根据提示手动创建后成功导入，最终切换到主工作界面

### 成功标准——用户交互
**核心交互**：用户打开页面直接看到"选择项目目录开始创作"按钮和标准目录规范说明（`0-小说设定`、`1-故事大纲`、`2-故事概要`、`3-小说内容`），一键点击即可选择本地目录导入。系统严格验证目录名称，提供明确的成功/失败反馈。用户感受是"规范清晰，操作简单"。

### 开发总结要求
- [ ] **项目导入功能总结已完成**
- [ ] 记录目录验证逻辑实现细节
- [ ] 记录用户体验优化措施
- [ ] 记录测试用例覆盖情况

## Epic 2: 主工作界面搭建

### 目标
构建导入成功后显示的完整工作界面框架，确保所有界面组件一次性完整实现

### 文件权限控制
**允许新增**：
- `src/client/src/components/workspace/`(工作区组件)
- `src/client/src/components/editor/`(编辑器组件)
- `src/client/src/stores/`(状态管理)

**禁止修改**：
- `src/server/`(后端代码)
- `src/shared/types/api.ts`(API接口类型)

### 核心功能
**左侧交互区(响应式)**：
- **简洁切换系统**：[对话] | [项目] 选项卡
- **对话Tab内容**：AI角色对话区 + 消息滚动 + 输入框
- **项目Tab内容**：文件列表 + 直观的目录结构

**右侧内容区(自适应)**：
- **单文件编辑**：当前打开的文件编辑器
- **文档编辑区**：Markdown富文本编辑 + 自动保存

**完整界面布局**：
```
┌─────────────────┬───────────────────────────────┐
│   左侧交互区    │        右侧内容区              │
├─────────────────┼───────────────────────────────┤
│  [对话] [项目]  │      当前编辑文件Tab           │
│                 │    ┌─────────────────────────┐  │
│ ┌─────────────┐ │    │ 文件名.md            × │  │
│ │AI角色对话区 │ │    └─────────────────────────┘  │
│ │+ 角色切换   │ │                               │
│ └─────────────┘ │         文档编辑区域            │
│      或         │                               │
│ ┌─────────────┐ │                               │
│ │项目导航树   │ │                               │
│ └─────────────┘ │                               │
└─────────────────┴───────────────────────────────┘
```

### 成功标准
用户导入项目后能看到完整的工作界面，可以在对话和项目Tab间切换，浏览项目文件结构，点击文件后右侧显示简洁的单文件编辑器，所有界面交互完全可用

### 成功标准——用户交互
用户导入项目后立即进入专业的创作工作台，左侧能直观地在AI对话和项目文件间切换，右侧展现简洁清晰的单文件编辑环境。整体感受像专业写作软件，用户能立即开始浏览、编辑文件，界面简洁舒适，响应流畅无卡顿。

### 开发总结要求
- [ ] **主工作界面搭建总结已完成**
- [ ] 记录界面布局设计思路
- [ ] 记录组件架构和状态管理方案
- [ ] 记录响应式设计实现

## Epic 3: 文件操作功能

### 目标
实现基础的文件读取、编辑、保存功能

### 文件权限控制
**允许新增**：
- `src/client/src/services/fileSystem.ts`(文件系统服务)
- `src/server/api/files.ts`(文件API)
- `src/server/middleware/fileHandler.ts`(文件处理中间件)

**禁止修改**：
- `src/server/app.ts`(后端入口)
- 其他Epic的专用文件

### 核心功能
- 文件读取显示
- 编辑和保存
- 实时同步本地

### 成功标准
用户可以打开、编辑、保存项目中的文件，所有修改实时同步到本地

### 成功标准——用户交互
用户点击任意文件即可打开编辑，输入内容时感受流畅，保存操作对用户透明（自动保存+手动保存），能明确看到文件修改状态。最重要的是用户确信所有改动都安全地保存到了本地文件中，不会有数据丢失担忧。

### 开发总结要求
- [ ] **文件操作功能总结已完成**
- [ ] 记录文件系统API选择和实现方案
- [ ] 记录自动保存机制和错误处理
- [ ] 记录性能优化和安全措施

## Epic 4: AI基础服务集成

### 目标
建立基础的Google Gemini API连接和对话功能

### 核心功能
**原生Gemini API集成**：
- 原生Google Gemini API客户端实现
- 基础对话接口和错误处理
- API重试机制和性能优化
- 对话上下文管理

**技术架构**：
```javascript
backend/
├── lib/
│   ├── gemini-client.js     // 原生Gemini客户端
│   ├── conversation-manager.js // 对话上下文管理
│   └── error-handler.js     // 错误处理和重试
├── routes/
│   └── chat.js              // 对话API路由
├── config/
│   └── gemini-config.json   // Gemini API配置
```

**核心实现参考**：
```javascript
// lib/gemini-client.js - 原生Gemini客户端
class GeminiClient {
  constructor(apiKey) {
    this.apiKey = apiKey;
    this.baseURL = 'https://generativelanguage.googleapis.com/v1beta';
  }

  async chat(messages, options = {}) {
    const response = await fetch(`${this.baseURL}/models/gemini-pro:generateContent?key=${this.apiKey}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        contents: this.formatMessages(messages),
        generationConfig: {
          temperature: options.temperature || 0.7,
          maxOutputTokens: options.maxTokens || 2048
        }
      })
    });
    
    if (!response.ok) {
      throw new Error(`Gemini API error: ${response.statusText}`);
    }
    
    return response.json();
  }

  formatMessages(messages) {
    // 转换为Gemini API格式
    return messages.map(msg => ({
      role: msg.role === 'assistant' ? 'model' : 'user',
      parts: [{ text: msg.content }]
    }));
  }
}
```

### 成功标准
用户可以通过Gemini API与AI进行对话，系统能稳定处理API调用，支持基础的对话上下文管理

### 成功标准——用户交互
用户在左侧对话区输入消息后，能稳定收到AI回复，响应时间在可接受范围内（<10秒），系统有明确的加载提示。用户感受到的是"有一个智能助手在帮助我"，而不是在使用复杂的技术工具。

## Epic 5: PromptX MCP集成

### 目标
基于MCP协议集成PromptX服务，建立角色和记忆系统基础

### 核心功能
**MCP客户端集成**：
- 集成`@modelcontextprotocol/sdk`客户端
- 配置PromptX MCP服务器连接
- 实现MCP工具调用封装(promptx_action, promptx_remember, promptx_recall)

**记忆系统集成**：
- PromptX记忆保存和回忆功能
- 智能记忆触发机制
- 会话记忆与长期记忆结合

**技术架构**：
```javascript
backend/
├── lib/
│   ├── mcp-client.js        // 核心MCP客户端
│   ├── promptx-client.js    // PromptX专用封装
│   └── memory-manager.js    // 记忆管理器
├── config/
│   └── mcp-servers.json     // MCP服务器配置
```

### 成功标准
系统能成功连接PromptX MCP服务，实现记忆保存和回忆功能，为角色系统提供基础支持

### 成功标准——用户交互
用户感受不到PromptX MCP的复杂性，只是发现AI助手"变聪明了"，能记住之前的创作内容和偏好，提供更个性化的建议。系统在后台智能管理记忆，用户不需要手动操作记忆功能。

## Epic 6: 总监角色验证集成

### 目标
集成并验证总监角色的完整功能

### 核心功能
**总监角色激活**：
- 通过MCP调用总监角色
- 角色状态管理和上下文维护
- 总监专业能力验证

**功能验证**：
- 总监的全局统筹功能
- 质量把控和建议能力
- 跨文章协调功能测试

### 成功标准
总监角色能正常激活和工作，提供专业的全局建议和质量把控功能

### 成功标准——用户交互
用户点击"总监"角色按钮后，能明显感受到AI对话风格的变化，开始从宏观视角提供统筹建议。用户感受就像有一位经验丰富的编辑在审视整部作品，提供专业的全局指导意见。

## Epic 7: 完整4角色系统集成

### 目标
集成剩余的架构师、规划师、写手角色，建立完整的4角色协作系统

### 核心功能
**剩余3角色集成**：
- 架构师角色激活和验证
- 规划师角色激活和验证  
- 写手角色激活和验证

**角色协作机制**：
- 智能角色路由系统
- 角色间状态传递
- 统一的角色管理接口

**系统集成测试**：
- 4角色完整对话流程测试
- 角色切换和状态管理验证
- 系统稳定性和性能测试

### 成功标准
用户可以与完整的4角色系统进行协作，系统能根据内容类型智能路由角色，角色切换流畅稳定

### 成功标准——用户交互
用户拥有了一个完整的"创作团队"，每个角色都有鲜明的专业特色：架构师帮助构建世界观、规划师设计情节结构、写手润色文字、总监统筹质量。用户在不同创作阶段能感受到最合适的专业协助，角色切换自然流畅。

## Epic 8: 架构师角色创作流程

### 目标
实现架构师角色主导的小说设定创作完整流程

### 核心功能
- 小说设定阶段的5步引导流程
- 三维度模板系统（故事世界/主题/角色）
- 智能归类和信息整理
- 设定完整性检查和验收

### 成功标准
用户可以与架构师完成完整的世界观设定，输出符合标准模板的3个设定文件

### 成功标准——用户交互
用户像与资深编剧聊天一样自然地表达创意想法，架构师耐心听取并智能整理归类。用户不需要记忆复杂的模板格式，只需要专注于创意表达，最终获得专业完整的世界观设定文档，感受是"我的想法变得更有条理了"。

## Epic 9: 规划师角色创作流程（大纲）

### 目标
实现规划师角色主导的故事大纲创作流程

### 核心功能
- 故事大纲的4步创作流程
- 四要素大纲模板系统
- 主题深度分析和价值立意引导
- 大纲与设定的一致性检查

### 成功标准
用户可以与规划师创建完整的故事大纲，确保与设定内容一致

### 成功标准——用户交互
用户与规划师讨论故事走向时，感受像与专业故事策划师合作。规划师能深度理解设定内容，提供符合世界观的情节建议。用户专注于故事创意，规划师负责结构化整理，最终得到逻辑清晰、主题明确的故事大纲。

## Epic 10: 规划师角色创作流程（概要）

### 目标
实现基于6步逻辑骨架的详细故事概要创作

### 核心功能
- 基于6步逻辑骨架的概要创作
- 情节发展脉络智能检查
- 关键要素和悬念设置引导
- 概要与大纲一致性验证

### 成功标准
用户可以创建详细的故事概要，严格遵循6步逻辑结构，与大纲保持一致

### 成功标准——用户交互
用户在规划师的引导下，将大纲细化为具体的故事框架。整个过程感受像资深编剧在帮助完善剧本结构，规划师确保每个情节点都有逻辑支撑。用户获得的是可以直接指导写作的详细故事蓝图，心中有底"知道怎么写了"。

## Epic 11: 写手角色创作流程

### 目标
实现写手角色主导的高质量小说内容创作

### 核心功能
- 结构化内容创作流程
- 6步逻辑的篇幅分配算法
- 文学品质检查和优化建议
- 内容修订和品质控制系统

### 成功标准
用户可以与写手创作高质量的小说内容，严格按照概要结构执行

### 成功标准——用户交互
用户与写手协作时，感受像与专业作家共同创作。写手不仅提供文字润色建议，还能主动创作符合概要要求的内容片段。用户可以专注于创意和情感表达，写手负责文学技巧和语言品质，最终产出让用户满意的高质量小说章节。

## Epic 12: 智能依赖和高级特性

### 目标
完善智能依赖识别机制，增强用户体验

### 核心功能
- 依赖后置机制完善
- 友好依赖提示和引导
- 系统优化和用户体验增强

### 成功标准
用户可以自由创作任意内容，系统提供智能依赖建议，整体体验流畅

### 成功标准——用户交互
用户获得完全的创作自由，想到什么就能创作什么，系统在后台智能分析依赖关系并友好提醒。用户感受是"系统很聪明，但不强制我按特定顺序创作"，依赖提示温和有用而不打断创作流程。整体体验达到专业创作软件的水准。

## 开发优先级

### 阶段0：技术搭建（Epic 0）
搭建前后端基础技术架构，确保项目能正常运行和构建

### 阶段1：基础架构（Epic 1-3）
建立完整的项目导入、主工作界面和文件操作基础，用户可以基本使用系统

### 阶段2：AI基础服务（Epic 4-5）
建立大模型API连接和PromptX MCP集成基础，为AI功能提供支撑

### 阶段3：角色系统建立（Epic 6-7）
先验证总监角色，再完成完整4角色系统集成，确保角色系统稳定可用

### 阶段4：创作流程核心（Epic 8-11）
按创作阶段顺序实现4角色的完整创作流程：设定→大纲→概要→内容

### 阶段5：系统完善（Epic 12）
实现智能依赖识别和高级特性，完善整体用户体验

## 总结

此Epic架构设计遵循了前端开发的基本规律：先静态页面、后动态交互、再业务逻辑。确保每个阶段都有明确的产出和可验证的功能点。