# 小说创作系统 - Epic架构设计

## 总体架构概述

基于用户使用流程的Epic划分，确保每个Epic都有明确的界面产出和功能边界。

## Epic 1: 项目导入引导流程

### 目标
实现用户打开网站后的项目导入引导，这是整个应用的入口

### 核心功能
- 欢迎页面和导入引导（包含目录规范示例文字）
- 目录选择和关键词智能识别（"设定""大纲""概要""内容"）
- 空目录自动创建标准4目录结构（系统安全操作）
- 缺失目录识别和用户手动创建提示
- 严格格式示例展示和重新导入机制
- 导入成功后的界面状态切换

### 成功标准
用户通过界面引导了解目录规范，可以成功导入完整的本地项目，或在空目录中自动获得标准结构，缺失目录时能根据提示手动创建后成功导入，最终切换到主工作界面

## Epic 2: 主工作界面搭建

### 目标
构建导入成功后显示的完整工作界面框架，确保所有界面组件一次性完整实现

### 核心功能
**左侧交互区(320px)**：
- **双Tab切换系统**：[对话] | [项目] 选项卡
- **对话Tab内容**：AI角色对话区 + 消息滚动 + 输入框 + 4角色切换按钮 + 时间戳
- **项目Tab内容**：4类型导航(设定/大纲/概要/内容) + 文件列表 + 依赖状态指示

**右侧内容区(自适应)**：
- **顶层Tab栏**：文件Tab自动创建 + 支持关闭/拖拽 + 最多8个限制
- **内层Tab栏**：智能显示依赖链条(设定|大纲|概要|当前) + 便捷校对功能
- **文档编辑区**：Markdown富文本编辑 + 实时预览 + 字数统计 + 自动保存状态指示

**完整界面布局**：
```
┌─────────────────┬───────────────────────────────┐
│   左侧交互区    │        右侧内容区              │
├─────────────────┼───────────────────────────────┤
│  [对话] [项目]  │    ┌─顶层Tab栏─────────────┐   │
│                 │    │Tab1 | Tab2 | Tab3 | × │   │
│ ┌─────────────┐ │    └─────────────────────────┘   │
│ │AI角色对话区 │ │    ┌─内层Tab栏─────────────┐   │
│ │+ 角色切换   │ │    │设定|大纲|概要|当前   │   │
│ └─────────────┘ │    └─────────────────────────┘   │
│      或         │         文档编辑区域            │
│ ┌─────────────┐ │                               │
│ │项目导航树   │ │                               │
│ └─────────────┘ │                               │
└─────────────────┴───────────────────────────────┘
```

### 成功标准
用户导入项目后能看到完整的工作界面，可以在对话和项目Tab间切换，浏览项目文件结构，打开文件后右侧显示双层Tab和编辑器，所有界面交互完全可用

## Epic 3: 文件操作功能

### 目标
实现基础的文件读取、编辑、保存功能

### 核心功能
- 文件读取显示
- 编辑和保存
- 实时同步本地

### 成功标准
用户可以打开、编辑、保存项目中的文件，所有修改实时同步到本地

## Epic 4: AI基础服务集成

### 目标
建立基础的Google Gemini API连接和对话功能

### 核心功能
**原生Gemini API集成**：
- 原生Google Gemini API客户端实现
- 基础对话接口和错误处理
- API重试机制和性能优化
- 对话上下文管理

**技术架构**：
```javascript
backend/
├── lib/
│   ├── gemini-client.js     // 原生Gemini客户端
│   ├── conversation-manager.js // 对话上下文管理
│   └── error-handler.js     // 错误处理和重试
├── routes/
│   └── chat.js              // 对话API路由
├── config/
│   └── gemini-config.json   // Gemini API配置
```

**核心实现参考**：
```javascript
// lib/gemini-client.js - 原生Gemini客户端
class GeminiClient {
  constructor(apiKey) {
    this.apiKey = apiKey;
    this.baseURL = 'https://generativelanguage.googleapis.com/v1beta';
  }

  async chat(messages, options = {}) {
    const response = await fetch(`${this.baseURL}/models/gemini-pro:generateContent?key=${this.apiKey}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        contents: this.formatMessages(messages),
        generationConfig: {
          temperature: options.temperature || 0.7,
          maxOutputTokens: options.maxTokens || 2048
        }
      })
    });
    
    if (!response.ok) {
      throw new Error(`Gemini API error: ${response.statusText}`);
    }
    
    return response.json();
  }

  formatMessages(messages) {
    // 转换为Gemini API格式
    return messages.map(msg => ({
      role: msg.role === 'assistant' ? 'model' : 'user',
      parts: [{ text: msg.content }]
    }));
  }
}
```

### 成功标准
用户可以通过Gemini API与AI进行对话，系统能稳定处理API调用，支持基础的对话上下文管理

## Epic 5: PromptX MCP集成

### 目标
基于MCP协议集成PromptX服务，建立角色和记忆系统基础

### 核心功能
**MCP客户端集成**：
- 集成`@modelcontextprotocol/sdk`客户端
- 配置PromptX MCP服务器连接
- 实现MCP工具调用封装(promptx_action, promptx_remember, promptx_recall)

**记忆系统集成**：
- PromptX记忆保存和回忆功能
- 智能记忆触发机制
- 会话记忆与长期记忆结合

**技术架构**：
```javascript
backend/
├── lib/
│   ├── mcp-client.js        // 核心MCP客户端
│   ├── promptx-client.js    // PromptX专用封装
│   └── memory-manager.js    // 记忆管理器
├── config/
│   └── mcp-servers.json     // MCP服务器配置
```

### 成功标准
系统能成功连接PromptX MCP服务，实现记忆保存和回忆功能，为角色系统提供基础支持

## Epic 6: 总监角色验证集成

### 目标
集成并验证总监角色的完整功能

### 核心功能
**总监角色激活**：
- 通过MCP调用总监角色
- 角色状态管理和上下文维护
- 总监专业能力验证

**功能验证**：
- 总监的全局统筹功能
- 质量把控和建议能力
- 跨文章协调功能测试

### 成功标准
总监角色能正常激活和工作，提供专业的全局建议和质量把控功能

## Epic 7: 完整4角色系统集成

### 目标
集成剩余的架构师、规划师、写手角色，建立完整的4角色协作系统

### 核心功能
**剩余3角色集成**：
- 架构师角色激活和验证
- 规划师角色激活和验证  
- 写手角色激活和验证

**角色协作机制**：
- 智能角色路由系统
- 角色间状态传递
- 统一的角色管理接口

**系统集成测试**：
- 4角色完整对话流程测试
- 角色切换和状态管理验证
- 系统稳定性和性能测试

### 成功标准
用户可以与完整的4角色系统进行协作，系统能根据内容类型智能路由角色，角色切换流畅稳定

## Epic 8: 架构师角色创作流程

### 目标
实现架构师角色主导的小说设定创作完整流程

### 核心功能
- 小说设定阶段的5步引导流程
- 三维度模板系统（故事世界/主题/角色）
- 智能归类和信息整理
- 设定完整性检查和验收

### 成功标准
用户可以与架构师完成完整的世界观设定，输出符合标准模板的3个设定文件

## Epic 9: 规划师角色创作流程（大纲）

### 目标
实现规划师角色主导的故事大纲创作流程

### 核心功能
- 故事大纲的4步创作流程
- 四要素大纲模板系统
- 主题深度分析和价值立意引导
- 大纲与设定的一致性检查

### 成功标准
用户可以与规划师创建完整的故事大纲，确保与设定内容一致

## Epic 10: 规划师角色创作流程（概要）

### 目标
实现基于6步逻辑骨架的详细故事概要创作

### 核心功能
- 基于6步逻辑骨架的概要创作
- 情节发展脉络智能检查
- 关键要素和悬念设置引导
- 概要与大纲一致性验证

### 成功标准
用户可以创建详细的故事概要，严格遵循6步逻辑结构，与大纲保持一致

## Epic 11: 写手角色创作流程

### 目标
实现写手角色主导的高质量小说内容创作

### 核心功能
- 结构化内容创作流程
- 6步逻辑的篇幅分配算法
- 文学品质检查和优化建议
- 内容修订和品质控制系统

### 成功标准
用户可以与写手创作高质量的小说内容，严格按照概要结构执行

## Epic 12: 智能依赖和高级特性

### 目标
完善智能依赖识别机制，增强用户体验

### 核心功能
- 依赖后置机制完善
- 友好依赖提示和引导
- 系统优化和用户体验增强

### 成功标准
用户可以自由创作任意内容，系统提供智能依赖建议，整体体验流畅

## 开发优先级

### 阶段1：基础架构（Epic 1-3）
建立完整的项目导入、主工作界面和文件操作基础，用户可以基本使用系统

### 阶段2：AI基础服务（Epic 4-5）
建立大模型API连接和PromptX MCP集成基础，为AI功能提供支撑

### 阶段3：角色系统建立（Epic 6-7）
先验证总监角色，再完成完整4角色系统集成，确保角色系统稳定可用

### 阶段4：创作流程核心（Epic 8-11）
按创作阶段顺序实现4角色的完整创作流程：设定→大纲→概要→内容

### 阶段5：系统完善（Epic 12）
实现智能依赖识别和高级特性，完善整体用户体验

## 总结

此Epic架构设计遵循了前端开发的基本规律：先静态页面、后动态交互、再业务逻辑。确保每个阶段都有明确的产出和可验证的功能点。