# 小说创作系统 - 技术架构设计方案

## 架构概述

### 设计原则
- **前后端分离**：职责边界清晰
- **Apple Style设计**：清晰、内容优先、简洁
- **响应式布局**：适配不同屏幕尺寸
- **低耦合高内聚**：模块化设计
- **高健壮性**：错误处理和容错机制
- **本地化优先**：用户完全控制数据
- **AI驱动**：4角色协作核心

### 整体架构
```
Frontend(React) ──→ Backend(Node.js) ──→ External APIs(Gemini/PromptX)
       │
Local FileSystem
```

### 技术栈
**前端**：React 18 + TypeScript + Zustand + Shadcn/ui + Monaco Editor
**后端**：Node.js + Express + TypeScript + Gemini API

## 项目架构

### 统一目录结构
```
novel-sys/
├── src/
│   ├── client/           # 前端代码
│   │   ├── components/   # React组件
│   │   ├── pages/        # 页面组件
│   │   ├── stores/       # 状态管理
│   │   ├── hooks/        # 自定义Hook
│   │   └── services/     # 前端服务
│   ├── server/           # 后端代码
│   │   ├── api/          # API路由层
│   │   ├── services/     # 业务服务层
│   │   │   ├── ai/       # Gemini AI服务
│   │   │   ├── project/  # 项目管理
│   │   │   └── file/     # 文件操作
│   │   ├── core/         # 核心业务逻辑
│   │   ├── middleware/   # 中间件
│   │   ├── models/       # 数据模型
│   │   └── app.ts        # 服务器入口
│   ├── shared/           # 前后端共享
│   │   ├── types/        # 公共类型
│   │   ├── constants/    # 公共常量
│   │   ├── utils/        # 通用工具
│   │   └── schemas/      # 数据验证
│   └── config/           # 配置管理
├── public/               # 静态资源
├── docs/                 # 项目文档
│   ├── NOVEL_CREATION_TASKS/ # Epic拆解任务文档
│   ├── 开发总结/         # AI开发总结备份文件夹
│   └── *.md              # 各种设计文档
└── scripts/              # 构建脚本
```

### 前端模块

**UI框架选择：Shadcn/ui + Apple Style设计**
- **Apple Style适配**：支持清晰、内容优先的设计原则
- **响应式支持**：基于Tailwind CSS，天然支持响应式布局
- **高度定制化**：组件代码直接复制到项目，可自由修改样式和逻辑
- **性能优异**：无运行时依赖，只包含使用的组件代码
- **TypeScript友好**：原生TypeScript支持，完整类型安全

**核心组件**：
- 工作区布局：左侧交互区(响应式) + 右侧内容区(自适应)
- 左侧：对话Tab + 项目Tab，右侧：简洁单文件编辑器
- 关键组件：Resizable(响应式分栏) + Dialog(弹窗) + Toast(提示) + 简洁Tab

**状态管理**：Zustand管理app/project/ai/files状态
**服务层**：API服务 + 文件服务 + File System Access API

### 后端模块

### 核心服务

**Express应用**：
- 安全中间件：helmet + cors + morgan
- API路由：/api/ai + /api/file + /api/project
- 健康检查 + 全局错误处理

**AI服务设计：直接Gemini API**

**技术选型**：
- **模型**：仅支持Google Gemini API
- **实现方式**：原生API调用，简单直接
- **角色系统**：基于prompt模板切换角色
- **记忆管理**：依托PromptX自带记忆功能

**简化实现**：
```typescript
// 保留接口抽象，便于后续扩展
interface BaseAIProvider {
  chat(message: string, role?: string): Promise<string>;
}

// Gemini实现
class GeminiAIService implements BaseAIProvider {
  private geminiClient: GeminiClient;
  
  async chat(message: string, role?: string): Promise<string> {
    try {
      const response = await this.geminiClient.generateContent({
        prompt: role ? `${role}\n\n${message}` : message
      });
      return response.text();
    } catch (error) {
      throw new Error(`AI服务调用失败: ${error.message}`);
    }
  }
}
```

**AI服务管理**：
- **Gemini API**：直接调用，基础错误处理
- **4角色系统**：通过prompt模板实现角色切换
- **记忆管理**：完全依托PromptX自带记忆功能

## 通信协议

### HTTP API

**响应格式**：{success, data?, error?, timestamp}
**核心接口**：
- AI类：/api/ai/roles/activate + /api/ai/chat + /api/ai/memory
- 项目类：/api/project/import + /api/project/validate
- 文件类：/api/file/read + /api/file/write + /api/file/list

### HTTP API通信

**简化设计**：使用标准HTTP API，无需WebSocket复杂性

## 错误处理和健壮性

### 错误处理

**简化错误处理**：
```typescript
// 基础try-catch错误处理
try {
  const result = await aiService.chat(message);
  res.json({ success: true, data: result });
} catch (error) {
  res.status(500).json({ 
    success: false, 
    error: error.message || 'AI服务暂时不可用' 
  });
}
```

## 部署和监控

### 本地开发部署
**开发服务**：
- frontend：React应用(3000端口)
- backend：Node.js API(3001端口)

### 监控和日志
**健康检查**：基本服务状态检查
```typescript
// 简单的健康检查接口
app.get('/health', (req, res) => {
  res.json({ 
    status: 'ok', 
    timestamp: new Date().toISOString(),
    service: 'novel-creation-system' 
  });
});
```
**日志系统**：console.log基础日志

## 开发配置

### 配置管理

**简化配置**：直接读取环境变量
```typescript
// 配置直接从环境变量读取
const config = {
  geminiApiKey: process.env.GEMINI_API_KEY!,
  frontendUrl: process.env.FRONTEND_URL || 'http://localhost:3000',
  appName: '小说创作系统'
};
```

**环境变量**：GEMINI_API_KEY（必需）+ FRONTEND_URL（可选）


## 总结

### 架构优势
- **极简设计**：直接Gemini API调用，无中间层
- **快速开发**：去掉复杂抽象，专注核心功能
- **易于调试**：问题直接定位，无复杂依赖链
- **稳定可靠**：减少故障点，提高系统稳定性

### 风险缓解
- **AI服务不稳定** → 基础错误提示
- **本地文件限制** → File System Access API
- **记忆管理** → 完全依托PromptX处理

该架构遵循奥卡姆剃刀原则：最简方案解决核心需求，避免过度工程化。
