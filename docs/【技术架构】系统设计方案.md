# 小说创作系统 - 技术架构设计方案

## 架构概述

### 设计原则
- **前后端分离**：职责边界清晰
- **低耦合高内聚**：模块化设计 
- **高健壮性**：错误处理和容错机制
- **本地化优先**：用户完全控制数据
- **AI驱动**：4角色协作核心

### 整体架构
```
Frontend(React) ──→ Backend(Node.js) ──→ External APIs(Gemini/PromptX)
       │
Local FileSystem
```

### 技术栈
**前端**：React 18 + TypeScript + Zustand + Shadcn/ui + Monaco Editor + Axios
**后端**：Node.js + Express + TypeScript + Gemini API + MCP SDK + WebSocket

## 项目架构

### 统一目录结构
```
novel-sys/
├── src/
│   ├── client/           # 前端代码
│   │   ├── components/   # React组件
│   │   ├── pages/        # 页面组件
│   │   ├── stores/       # 状态管理
│   │   ├── hooks/        # 自定义Hook
│   │   └── services/     # 前端服务
│   ├── server/           # 后端代码
│   │   ├── api/          # API路由层
│   │   ├── services/     # 业务服务层
│   │   │   ├── ai/       # AI服务(Gemini/PromptX)
│   │   │   ├── memory/   # 记忆管理
│   │   │   ├── project/  # 项目管理
│   │   │   └── file/     # 文件操作
│   │   ├── core/         # 核心业务逻辑
│   │   ├── middleware/   # 中间件
│   │   ├── models/       # 数据模型
│   │   └── app.ts        # 服务器入口
│   ├── shared/           # 前后端共享
│   │   ├── types/        # 公共类型
│   │   ├── constants/    # 公共常量
│   │   ├── utils/        # 通用工具
│   │   └── schemas/      # 数据验证
│   └── config/           # 配置管理
├── public/               # 静态资源
├── docs/                 # 项目文档
│   ├── 开发总结/         # AI开发总结备份文件夹
│   └── *.md              # 各种设计文档
├── tests/                # 测试
└── scripts/              # 构建脚本
```

### 前端模块

**UI框架选择：Shadcn/ui**
- **极简风格匹配**：基于Tailwind CSS，天然支持黑白灰配色方案
- **高度定制化**：组件代码直接复制到项目，可自由修改样式和逻辑
- **性能优异**：无运行时依赖，只包含使用的组件代码
- **TypeScript友好**：原生TypeScript支持，完整类型安全
- **Monaco Editor兼容**：已验证与Monaco Editor良好集成

**核心组件**：
- 工作区布局：左侧交互区(320px) + 右侧内容区
- 左侧：对话Tab + 项目Tab，右侧：文件Tab栏 + 编辑器
- 关键组件：Resizable(分栏) + Tabs(多层Tab) + Dialog(弹窗) + Toast(提示)

**状态管理**：Zustand管理app/project/ai/files状态
**服务层**：API服务 + 文件服务 + File System Access API

### 后端模块

### 核心服务

**Express应用**：
- 安全中间件：helmet + cors + morgan
- API路由：/api/ai + /api/file + /api/project
- 健康检查 + 全局错误处理

**大模型调用框架选择：原生API + 可扩展架构设计**

**当前版本**：
- **主要模型**：仅支持Google Gemini API
- **架构设计**：预留多模型扩展能力，便于后续添加OpenAI、Claude等
- **实现方式**：原生API调用，无中间框架依赖

**技术选型理由**（vs LangChain）：
- **学习成本低**：直接调用Gemini API，无需掌握复杂框架
- **性能最优**：无中间层开销，响应速度最快
- **扩展友好**：架构设计支持后续轻松添加新模型
- **调试简单**：问题直接定位到API层，便于排查

**可扩展架构设计**：
```typescript
src/server/services/ai/
├── providers/        # 模型提供商（预留扩展）
│   ├── base.ts      # 统一接口抽象（为未来扩展做准备）
│   └── gemini.ts    # 当前唯一实现：Gemini API
├── ai-service.ts    # AI服务入口（当前直接使用Gemini）
├── mcp/             # PromptX MCP集成
├── roles/           # 4角色系统管理
├── context/         # 上下文管理
└── stream/          # WebSocket流处理
```

**当前实现（Gemini Only）**：
```typescript
// 当前版本：直接使用Gemini
class AIService {
  private geminiClient: GeminiClient;
  private mcpClient: PromptXClient;
  
  async chatWithRole(role: RoleType, message: string): Promise<StreamResponse> {
    const rolePrompt = await this.getRolePrompt(role);
    return this.geminiClient.chat([...messages], options);
  }
}

// 预留扩展：BaseAIProvider接口（暂未使用）
abstract class BaseAIProvider {
  abstract chat(messages: Message[], options: ChatOptions): Promise<ChatResponse>;
  abstract stream(messages: Message[]): AsyncIterable<StreamChunk>;
}
```

**AI服务管理**：
- **当前支持**：Google Gemini API（gemini-pro模型）
- **架构预留**：BaseAIProvider抽象接口，便于后续扩展
- **4角色系统**：基于prompt模板实现角色切换
- **MCP集成**：通过PromptX管理角色记忆和上下文
- **流式处理**：原生支持WebSocket实时对话流

**PromptX MCP集成**：
- **连接管理**：初始化连接 + 状态监控
- **角色操作**：激活(promptx_action) + 获取提示词(promptx_recall) + 保存记忆(promptx_remember)
- **错误处理**：连接失败重试 + 降级方案

**Gemini API服务**：
- **API调用**：消息格式化 + 参数配置 + 安全设置
- **重试机制**：失败重试3次 + 指数退避
- **错误处理**：状态码检查 + 响应解析 + 异常抛出

### 记忆管理

**MemoryService**：
- **内存存储**：Map存储对话记录
- **对话存储**：保存对话 + 最近100条限制 + PromptX长期记忆
- **记忆检索**：内存短期 + PromptX长期 + 合并排序

## 通信协议

### HTTP API

**响应格式**：{success, data?, error?, timestamp}
**核心接口**：
- AI类：/api/ai/roles/activate + /api/ai/chat + /api/ai/memory
- 项目类：/api/project/analyze + /api/project/status
- 文件类：/api/file/read + /api/file/write

### WebSocket实时通信

**事件类型**：
- 上行：ai:chat/stop + file:watch/unwatch
- 下行：ai:response/thinking/error + file:changed + system:status

**连接管理**：客户端映射 + 消息路由 + 广播机制

## 错误处理和健壮性

### 错误处理

**分层错误类**：AppError + APIError + ValidationError + AIServiceError
**全局处理**：错误类型识别 + 状态码映射 + 统一响应格式

### 服务容错

**熔断器机制**：
- 状态：CLOSED/OPEN/HALF_OPEN
- 阈值：5次失败后熔断，60s后尝试恢复
- 降级：AI服务不可用时提示用户重试

## 部署和监控

### 本地开发部署
**开发服务**：
- frontend：React应用(3000端口)
- backend：Node.js API(3001端口)

### 监控和日志
**健康检查**：Gemini + PromptX服务状态监控  
**性能监控**：请求时间记录 + 慢请求警告(>1s)  
**日志系统**：console.log简单日志

## 开发和测试

### 配置管理

**统一配置类**（借鉴Pydantic模式）：
```typescript
// src/config/settings.ts
class Settings {
  // AI服务配置
  geminiApiKey: string;
  promptxMcpServer: string;
  defaultModel: 'gemini-pro' | 'gemini-pro-vision';
  
  // 应用配置
  appName: string = '小说创作系统';
  debug: boolean = false;
  
  // 存储配置
  memoryLimit: number = 100; // 最大对话记录数
  
  // 前端配置
  frontendUrl: string = 'http://localhost:3000';
}
```

**环境变量**：GEMINI_API_KEY + PROMPTX_MCP_* + FRONTEND_URL

### 测试策略
**单元测试**：Jest + 服务层逻辑测试  
**集成测试**：Supertest + API全流程测试  
**测试覆盖**：核心服务 + 错误场景 + 边界条件

## 总结

### 架构优势
- **清晰分层**：前后端职责明确，便于维护扩展
- **高内聚低耦合**：模块化设计，单一职责
- **健壮错误处理**：多层错误处理 + 服务降级
- **灵活AI集成**：支持多种AI服务和角色系统

### 风险缓解
- **AI服务不稳定** → 错误提示 + 重试机制
- **本地文件限制** → File System Access API + 降级支持
- **MCP连接问题** → 重连机制 + 基础模式

该架构全面覆盖PRD需求：AI角色协作 + 本地化安全 + 智能引导流程，同时保证系统可维护性和扩展性。